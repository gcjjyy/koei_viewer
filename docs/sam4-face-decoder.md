# 삼국지 4 얼굴 디코더 (sam4-face-decoder.ts)

## 개요

삼국지4(三國志IV)의 KAODATA.S4는 **2단계 압축**을 사용합니다:
1. **0xFE 이스케이프 RLE**: 바이트 레벨 런렝스
2. **니블 기반 백레퍼런스**: 4비트 제어 코드

### 기본 사양

| 항목 | 값 |
|------|-----|
| 이미지 크기 | 64 × 80 픽셀 |
| 색상 수 | 8색 (3비트) |
| 총 이미지 수 | 340개 |
| 인덱스 테이블 | 2040 바이트 (340 × 6) |
| 출력 크기 | 5120 픽셀 (64 × 80) |

## 사용법

```sh
# 전체 얼굴 렌더링
$ npx ts-node decode-sam4-faces.ts

# 결과: sam4-faces.png (1280×1360, 340개 얼굴)
```

## 모듈

| 파일 | 설명 |
|------|------|
| `sam4-face-decoder.ts` | 디코더 모듈 (decodeFace, decodeFaces export) |
| `decode-sam4-faces.ts` | 배치 실행 스크립트 |

## 압축 알고리즘

### 파일 구조

```
┌─────────────────────────────────────┐
│ 인덱스 테이블 (2040 바이트)           │
│ - 340개 엔트리 × 6바이트              │
│ - offset(4) + size(2)               │
├─────────────────────────────────────┤
│ 이미지 데이터 영역                    │
│ - 각 이미지: 4바이트 헤더 + 압축 데이터 │
└─────────────────────────────────────┘
```

### 1단계: 0xFE 이스케이프 RLE

| 바이트 | 동작 |
|--------|------|
| 일반 (≠0xFE) | 그대로 반환, 캐시에 저장 |
| 0xFE 0x01 | 리터럴 0xFE 반환 |
| 0xFE 0x00 | 캐시된 바이트 256번 반복 |
| 0xFE N (N>1) | 캐시된 바이트 N번 반복 |

### 2단계: 니블 기반 압축

각 줄 시작에 rowOffset 니블을 읽고, 이후 픽셀 루프:

| 제어 니블 | 동작 |
|-----------|------|
| bit3=0 | 리터럴: color = ctrl & 0x07 |
| bit3=1, bit2=0 | 짧은 백레퍼런스: length = (ctrl & 0x03) + 2 |
| bit3=1, bit2=1 | 긴 백레퍼런스: length = ((ctrl & 0x03) << 4) + nextNibble + 6 |

백레퍼런스 오프셋:
- rowOffset & 0x08: 행 방향 (srcY = y - rowOffset + 7)
- 그 외: 열 방향 (srcX = x - rowOffset - 1)

## 스크린샷

![sam4](../output/sam4-faces.png)
