# Sangokushi 4 (삼국지4) KAODATA.S4 파일 포맷 분석

## 분석 일자
2024-01-02

## 파일 구조

### 인덱스 테이블
- 위치: 파일 시작 (offset 0)
- 크기: 2040 bytes (340 images × 6 bytes)
- 엔트리 형식:
  - offset: 4 bytes (uint32 LE) - 데이터 영역 내 오프셋
  - size: 2 bytes (uint16 LE) - 압축된 데이터 크기

### 압축 데이터 영역
- 위치: offset 0x7F8 (2040)
- 각 이미지 헤더: 4 bytes
  - width: 2 bytes (uint16 LE) = 64 (0x40)
  - height: 2 bytes (uint16 LE) = 80 (0x50)

## MAIN.EXE 관련 함수 위치

### 얼굴 데이터 로딩 함수
- **주소: 0x250A0**
- 역할: 인덱스로 얼굴 데이터 로드 및 압축 해제
- 주요 연산:
  - `mul cx` (cx=6): 인덱스 엔트리 오프셋 계산
  - `add ax, 0x7F8`: 인덱스 테이블 크기 더함
  - `call 0x24E6C`: 압축 해제 함수 호출

### 압축 해제 함수
- **주소: 0x24E6C**
- 반환: `retf 0x8` (8바이트 파라미터)
- 내부 변수:
  - 0xC6D6: 플래그 워드 (니블 캐시)
  - 0xC6DA-0xC6DC: 출력 버퍼 주소
  - 0xC6DE-0xC6E0: 입력 버퍼 주소

### 헬퍼 함수들
- **0x24D3C**: 니블(4비트) 읽기
  - 플래그 워드에서 상위/하위 니블 교대로 반환
  - 플래그가 0xFF면 새 바이트 읽음

- **0x24D70**: 워드(16비트) 읽기
  - 입력 스트림에서 2바이트 읽어 워드로 조합

- **0x24D8E**: 비트플레인에서 픽셀 읽기
  - 3개 플레인에서 해당 위치 비트 읽음
  - 3비트 픽셀 값 반환

- **0x24DF4**: 비트플레인에 픽셀 쓰기
  - 3비트 픽셀 값을 3개 플레인에 기록

## 압축 알고리즘 상세

### 2단계 압축: 바이트 RLE + 니블 기반 백레퍼런스

#### 1단계: 바이트 레벨 RLE (0x4CD4)
입력 스트림에서 바이트를 읽을 때 0xFE 이스케이프 시퀀스 처리:
- **일반 바이트**: 그대로 반환, 캐시에 저장
- **0xFE 0x01**: 리터럴 0xFE 반환
- **0xFE 0x00**: 캐시된 바이트를 256번 반복
- **0xFE N** (N > 1): 캐시된 바이트를 N번 반복

#### 2단계: 니블 기반 압축 (0x24D40)
바이트를 읽고 상위/하위 니블을 교대로 반환:
- 플래그가 0xFFFF면 새 바이트 읽음, 상위 니블 반환
- 아니면 캐시된 하위 니블 반환, 플래그 리셋

#### 메인 디코딩 루프 (0x24EC0)

1. **각 줄 시작**: rowOffset = readNibble()
   - bit 3 (0x08): 오프셋 방향 결정
     - 1: 행 방향 (srcY = y - rowOffset + 7)
     - 0: 열 방향 (srcX = x - rowOffset - 1)

2. **픽셀 루프**: ctrl = readNibble()
   - **bit 3 = 1**: 백레퍼런스
     - bit 2 = 1: length = ((ctrl & 0x03) << 4) + readNibble() + 6
     - bit 2 = 0: length = (ctrl & 0x03) + 2
     - rowOffset에 따라 소스 위치 계산 후 복사
   - **bit 3 = 0**: 리터럴 픽셀
     - color = ctrl & 0x07 (0-7)
     - 현재 위치에 기록

## 비트플레인 형식

- 3bpp (3 bit planes)
- 각 라인: 64 pixels × 3 planes / 8 = 24 bytes
- 총 이미지: 24 bytes × 80 lines = 1920 bytes (비압축)

## 압축 크기 범위
- 최소: 1174 bytes
- 최대: 1927 bytes
- 평균: 약 1554 bytes
- 비압축: 1920 bytes

## 버퍼 주소 (MAIN.EXE)
- 0xBEEA: 얼굴 데이터 버퍼 세그먼트 핸들
- 0xBEFA: 관련 버퍼
- 0xBF44: 파일 핸들

## 참고
- 파일: /Users/gcjjyy/.doogie-cli/games/SAM4/Game/MAIN.EXE
- 문자열 "A:KAODATA.S4" 위치: 파일 오프셋 0x4745A
